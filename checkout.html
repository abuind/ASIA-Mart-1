<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Asia Mart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>Asia Mart</h1>
                    <p>Natural Cosmetics & Groceries</p>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="index.html#products" class="nav-link">Products</a>
                    <a href="cart.html" class="nav-link">
                        Cart <span class="cart-count">0</span>
                    </a>
                    <a href="login.html" class="nav-link" id="loginLink">Login</a>
                    <a href="#" class="nav-link" id="logoutLink" style="display: none;">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1>Checkout</h1>
            <div class="checkout-container">
                <div class="checkout-form-section">
                    <form id="checkoutForm">
                        <h2>Shipping Information</h2>
                        <div class="form-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone *</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Street Address *</label>
                            <input type="text" id="address" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City *</label>
                                <input type="text" id="city" required>
                            </div>
                            <div class="form-group">
                                <label for="state">State *</label>
                                <input type="text" id="state" required>
                            </div>
                            <div class="form-group">
                                <label for="zip">ZIP Code *</label>
                                <input type="text" id="zip" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="createAccount">
                                Create an account for faster checkout next time
                            </label>
                        </div>
                        <div id="accountPasswordSection" style="display: none;">
                            <div class="form-group">
                                <label for="password">Password *</label>
                                <input type="password" id="password" minlength="6">
                            </div>
                        </div>

                        <h2>Payment Method</h2>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="paymentMethod" value="mock" checked>
                                Mock Payment (Demo)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="paymentMethod" value="manual">
                                Manual Payment (Admin will confirm)
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary btn-large">Place Order</button>
                    </form>
                </div>
                <div class="checkout-summary-section">
                    <h2>Order Summary</h2>
                    <div id="orderItems">
                        <!-- Order items will be loaded here -->
                    </div>
                    <div class="summary-total">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="orderSubtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping:</span>
                            <span>Calculated separately</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="orderTotal">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Asia Mart</h3>
                    <p>Your trusted source for natural cosmetics and organic groceries.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Asia Mart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/db.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/cart.js"></script>
    <script>
        let dbReady = false;
        const initInterval = setInterval(() => {
            if (db) {
                dbReady = true;
                clearInterval(initInterval);
                initPage();
            }
        }, 100);

        let cartItems = [];

        async function initPage() {
            if (isCustomerLoggedIn()) {
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('logoutLink').style.display = 'inline';
                document.getElementById('logoutLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
                const user = getCurrentCustomer();
                if (user) {
                    document.getElementById('fullName').value = user.name || '';
                    document.getElementById('email').value = user.email || '';
                }
            }

            await loadOrderSummary();

            document.getElementById('createAccount').addEventListener('change', (e) => {
                document.getElementById('accountPasswordSection').style.display = e.target.checked ? 'block' : 'none';
                if (e.target.checked) {
                    document.getElementById('password').required = true;
                } else {
                    document.getElementById('password').required = false;
                }
            });

            document.getElementById('checkoutForm').addEventListener('submit', handleCheckout);
        }

        async function loadOrderSummary() {
            cartItems = await getCartItems();
            if (cartItems.length === 0) {
                showNotification('Your cart is empty', 'error');
                setTimeout(() => window.location.href = 'cart.html', 2000);
                return;
            }

            const orderItemsDiv = document.getElementById('orderItems');
            orderItemsDiv.innerHTML = cartItems.map(item => `
                <div class="order-item">
                    <div class="order-item-info">
                        <h4>${item.name}</h4>
                        <p>Quantity: ${item.quantity}</p>
                    </div>
                    <div class="order-item-price">
                        ${formatCurrency(item.price * item.quantity)}
                    </div>
                </div>
            `).join('');

            const total = calculateCartTotal(cartItems);
            document.getElementById('orderSubtotal').textContent = formatCurrency(total);
            document.getElementById('orderTotal').textContent = formatCurrency(total);
        }

        async function handleCheckout(e) {
            e.preventDefault();

            const formData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: {
                    street: document.getElementById('address').value.trim(),
                    city: document.getElementById('city').value.trim(),
                    state: document.getElementById('state').value.trim(),
                    zip: document.getElementById('zip').value.trim()
                },
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                createAccount: document.getElementById('createAccount').checked,
                password: document.getElementById('password').value
            };

            // Validation
            if (!validateEmail(formData.email)) {
                showNotification('Please enter a valid email', 'error');
                return;
            }

            if (!validatePhone(formData.phone)) {
                showNotification('Please enter a valid phone number', 'error');
                return;
            }

            if (formData.createAccount && formData.password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                // Create account if requested
                let customerId = getCurrentUserId();
                if (formData.createAccount && !customerId) {
                    const registerResult = await customerRegister(
                        formData.fullName,
                        formData.email,
                        formData.password,
                        formData.phone,
                        formData.address
                    );
                    if (registerResult.success) {
                        customerId = registerResult.user.id;
                    }
                } else if (!customerId) {
                    // Create guest customer record
                    const customer = {
                        name: formData.fullName,
                        email: formData.email,
                        phone: formData.phone,
                        address: formData.address,
                        createdAt: new Date().toISOString(),
                        orderCount: 0,
                        totalSpent: 0
                    };
                    customerId = await DB.add(STORES.CUSTOMERS, customer);
                }

                // Create order
                const order = {
                    customerId: customerId,
                    items: cartItems.map(item => ({
                        productId: item.productId,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    total: calculateCartTotal(cartItems),
                    status: 'Pending',
                    paymentMethod: formData.paymentMethod,
                    paymentStatus: formData.paymentMethod === 'mock' ? 'Paid' : 'Pending',
                    shippingAddress: formData.address,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const orderId = await DB.add(STORES.ORDERS, order);

                // Update product stock
                for (const item of cartItems) {
                    await updateProductStock(item.productId, item.quantity);
                }

                // Update customer stats
                const customer = await DB.get(STORES.CUSTOMERS, customerId);
                if (customer) {
                    customer.orderCount = (customer.orderCount || 0) + 1;
                    customer.totalSpent = (customer.totalSpent || 0) + order.total;
                    await DB.update(STORES.CUSTOMERS, customer);
                }

                // Clear cart
                await clearCart();

                // Show success and redirect
                showNotification('Order placed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `order-confirmation.html?orderId=${orderId}`;
                }, 1500);
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Error placing order. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>

